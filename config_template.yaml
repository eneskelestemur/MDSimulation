# Basic template for an MD run

# Run metadata and output root folder
run_name: "my_simulation"
output_root: "outputs"   # relative or absolute path

##### Simulation configuration #####
system:
  name: "complex"
  protein_paths:                        # list even if single file; receptor can be any mask later
    - "path/to/protein.pdb"             # PDB
  ligand_paths:                         # list even if single file; use mmgbsa masks to choose pairs
    - "path/to/ligand.sdf"              # SDF/MOL2/PDB
  rna_paths: []                         # list of PDBs (can be empty; can be part of MMGBSA masks)
  forcefields:                          # OpenMM FF XMLs, used for all components + solvation
    - "amber19-all.xml"
    - "amber19/tip3pfb.xml"

prep:                                    # Structure cleaning
  fix_missing_residues: true             # PDBFixer findMissingResidues (skip if you know sequences are complete)
  fix_missing_atoms: true                # PDBFixer find/add missing atoms
  add_hydrogens_pH: 7.0                  # pH for protonation
  remove_heterogens: true                # Strip heterogens (incl. waters) before modelling
  ligand_allow_undefined_stereo: true    # Permit undefined stereochemistry in ligands

solvation:                                # Modeller.addSolvent options
  enabled: true
  water_model: "tip3p"                   # water model string (must match a forcefield file)
  padding_nm: 1.0                         # nm padding around solute
  ionic_strength_m: 0.15                  # molar salt
  positive_ion: "Na+"
  negative_ion: "Cl-"
  neutralize: true
  solvent_kwargs: {}                      # extra kwargs passed to addSolvent

simulation:
  platform: "CUDA"                        # OpenMM platform
  temperature: 300.0                      # K
  friction: 1.0                           # 1/ps
  timestep_fs: 2.0                        # fs

  protocol:                                     # Phase controls
    minimize:                                   # Energy minimization
      enabled: true
      max_iterations: 0                         # 0 â†’ until convergence
      tolerance_kj_per_mol_nm: 10.0             # force tolerance
    nvt: { enabled: true, steps: 50000 }
    npt: { enabled: true, steps: 50000 }
    production_steps: 1000000
    nvt_start_temp_k: 5.0                       # ramp start temperature
    nvt_ramp_chunk_steps: 5                     # steps per temperature increment

  integrator:
    type: "LangevinMiddle"   # LangevinMiddle, Langevin, Verlet
    seed: null               # RNG seed (int) or null

  engine:
    constraints: null                     # HBonds, AllBonds, HAngles, or null
    rigid_water: true
    remove_cm_motion: true
    cutoff_nm: 1.0                        # nonbonded cutoff (nm)
    switch_distance_nm: 0.9               # switching distance (nm) or null
    ewald_error_tolerance: 0.0005         # PME tolerance
    dispersion_correction: null           # true/false/null for default
    hydrogen_mass: null                   # amu; set (e.g., 3.0) to enable HMR
    barostat_interval: 25                 # steps between barostat moves
    ligand_forcefield: "gaff-2.11"        # GAFF/SMIRNOFF/Espaloma string

  reporting:
    equilibration:
      interval: 1000                      # steps between reports
      state_file: "equil_state.log"
      dcd_file: "equil_trajectory.dcd"
      mdcrd_file: "equil.mdcrd"
      mdcrd_enabled: false                # enable if you need AMBER-format output
    production:
      interval: 10000
      state_file: "sim_state.log"
      dcd_file: "sim_trajectory.dcd"
      mdcrd_file: "sim.mdcrd"
      mdcrd_enabled: false
    checkpoint_interval: 10000            # steps between checkpoints (null to disable)
    checkpoint_file: "sim_checkpoint.chk"

output:
  keep_tmp: false                         # keep tmp/ after run
  keep_cache: true                        # keep cache/ (ligand templates) to speed later steps (e.g., MMGBSA)
  final_pdb: "simulated_complex.pdb"
  final_state_xml: "final_state.xml"
  initial_state_xml: "initial_state.xml"
  minimized_pdb: "minimized_complex.pdb"
  config_copy: "config_resolved.yaml"
  manifest: "manifest.json"

##### MMG(P)BSA configuration #####
mmgbsa:
  enabled: false
  # Use Amber mask syntax to choose any pair (protein/protein, protein/ligand, ligand/ligand, RNA, etc.)
  receptor_mask: null              # e.g., ":1-200" or ":PROA"
  ligand_mask: null                # e.g., ":LIG" or ":201-250"
  decomposition: null              # e.g., "residue"
  keep_files: 2                    # Amber keep_files level (0-2), stored in tmp/
  debug_printlevel: 1
  strip_mask: ":WAT:HOH:CL:CIO:CS:IB:K:LI:MG:NA:RB"
  startframe: 250                  # frame range/stride for analysis
  endframe: 1500
  interval: 25
  gb_enabled: true                 # set false to skip GB and run PB-only
  igb: 5
  saltcon: 0.150
  pb_enabled: false                # enable if you also want PB block
  istrng: 0.100
  radiopt: 0
  inp: 1
  # See Amber MMGBSA tutorial for detailed parameter meanings.

##### Analysis configuration #####
analysis:
  transformations:                      # applied once to trajectory before analyses
    enabled: false
    enable_no_jump: false               # use MDAnalysis NoJump (disables other transforms below)
    unwrap_selection: "all"             # selection to unwrap across PBC (null to skip)
    center_selection: "protein"         # selection to center and wrap in box (null to skip)
    save_format: "dcd"                  # dcd | xtc | trr | nc | mdcrd | trj | xyz
    save_interval: 1                    # stride for saving transformed frames
    save_filename: null                 # override output filename (defaults to sim_trajectory_transformed.<ext>)
  rmsd:
    enabled: false
    name: "rmsd"                        # output CSV filename (single file with multiple labels)
    reference: "minimized"              # minimized | final | external (applied to all selections)
    reference_path: null                # required if reference: external
    align_selection: "backbone"         # alignment selection applied to all selections
    stride: 1                           # default stride for all selections
    max_frames: null                    # default max_frames for all selections
    selections:
      - name: "backbone"                # label used in CSV/plot
        target_selection: "backbone"    # MDAnalysis selection to measure RMSD on
        stride: 1
        max_frames: null
      - name: "ligand"
        target_selection: "resname LIG"
        stride: 1
        max_frames: null
  rmsf:
    enabled: false
    name: "rmsf"
    align_selection: "backbone"           # shared alignment selection for all RMSF calculations
    stride: 1                             # default stride for selections
    max_frames: null                      # default max_frames for selections
    selections:
      - name: "backbone"
        target_selection: "backbone"
        stride: 1
        max_frames: null
  pairwise_rmsd:
    enabled: false
    name: "pairwise_rmsd"
    selection: "backbone"               # selection used for frame-vs-frame matrix
    align_selection: "backbone"         # optional alignment selection (applied before RMSD)
    stride: 1
    max_frames: null
  contacts:
    enabled: false
    name: "contacts"
    selection1:                         # defaults
      name: "protein"
      selection: "protein"
    selection2:
      name: "ligand"
      selection: "ligand"
    cutoff_angstrom: 4.0
    per_residue: true
    stride: 1
    max_frames: null

##### Visualization configuration #####
visualization:
  figure_dpi: 300                        # default DPI for saved figures
  rmsf:
    aggregate_by_residue: false           # default aggregation for all selections (overridden per selection below)
    selections:
      - name: "backbone"
        aggregate_by_residue: false       # per-selection aggregation override
  pairwise_rmsd:
    max_tick_labels: 30                   # max tick labels on each axis for pairwise RMSD heatmap
  contacts:
    top_n: 20                             # number of bars to show when using bar plot
